<!doctype html>
<html>
<head>
<meta charset="utf-8">
<title>CSP — Anchor to Price Cell • Advanced Chart + 200MA</title>
<meta name="viewport" content="width=device-width, initial-scale=1">
<style>
  body{margin:0;background:#0b0c0f;color:#e7ecf3;font:14px/1.4 -apple-system,BlinkMacSystemFont,"Segoe UI",Roboto,Arial,sans-serif}
  header{position:sticky;top:0;background:#0b0c0fea;border-bottom:1px solid #232933;padding:10px 14px;z-index:5}
  h1{font-size:16px;margin:0 0 4px 0}.sub{margin:0;color:#9aa4b2;font-size:12px}
  main{padding:14px;max-width:1400px;margin:0 auto}
  .row{display:flex;gap:8px;align-items:center;flex-wrap:wrap;margin-bottom:8px}
  input[type="file"]{color:#e7ecf3}
  input[type="text"]{background:#0e1116;border:1px solid #232933;color:#e7ecf3;border-radius:8px;padding:4px 6px}
  button{background:#1a2230;border:1px solid #232933;color:#e7ecf3;border-radius:8px;padding:6px 10px;cursor:pointer}
  button:hover{border-color:#385170}
  a{color:#a8c8ff;text-decoration:none}
  table{width:100%;border-collapse:collapse}
  th,td{border-bottom:1px solid #232933;padding:6px 8px;white-space:nowrap}
  th{background:#171b22;position:sticky;top:72px;cursor:pointer}
  tr:hover{background:#10141b}

  #panel{
    position:absolute; display:none; pointer-events:auto;
    border:1px solid #232933; background:#0e1116; border-radius:12px;
    padding:8px; width:520px; box-shadow:0 8px 30px rgba(0,0,0,.35); z-index:20
  }
  #panelHead{display:flex;align-items:center;gap:8px;margin-bottom:6px}
  #panelTitle{font-size:12px;color:#cfe0ff;margin:0}
  #panelHead .sp{flex:1}
  #panelClose{background:#2a3342;border:1px solid #334055;color:#e7ecf3;border-radius:8px;padding:4px 8px;cursor:pointer}
  #panelClose:hover{border-color:#4b6b9a}
  #tvContainer{width:500px;height:300px}
  .muted{color:#9aa4b2;font-size:12px}
</style>
</head>
<body>
<header>
  <h1>CSP — Dedup by Symbol (keep highest Ann Rtn) • Advanced TV chart anchored to Price cell + 200MA</h1>
  <p class="sub">Hover the Price cell → show chart with 200-day moving average. Panel persists until closed.</p>
</header>
<main>
  <div class="row">
    <input id="csv" type="file" accept=".csv">
    <button id="go">Run</button>
    <button id="openTV" disabled>Open Chart</button>
    <button id="exportTV" disabled>Export TV list</button>
    <a id="dl" download="deduped.csv" style="display:none">Download CSV</a>
    <span id="stats" class="muted"></span>
    <span class="muted" style="margin-left:auto">TV prefix: <input id="prefix" placeholder="e.g. NASDAQ:" style="width:120px"></span>
  </div>
  <div id="tablewrap"></div>
</main>

<div id="panel">
  <div id="panelHead">
    <h3 id="panelTitle"></h3>
    <div class="sp"></div>
    <button id="panelClose" title="Close (Esc)">Close</button>
  </div>
  <div id="tvContainer"></div>
</div>

<script src="https://s3.tradingview.com/tv.js"></script>
<script>
function norm(s){return String(s||"").toLowerCase().trim();}
function toNum(x){if(x==null)return NaN;let s=String(x).replace(/,/g,"").trim();if(s.endsWith("%"))s=s.slice(0,-1);return parseFloat(s);}
function parseCSV(txt){const out=[];let cur=[],cell="",q=false;for(let i=0;i<txt.length;i++){const c=txt[i];if(q){if(c==='\"'){if(txt[i+1]==='\"'){cell+='\"';i++;}else{q=false;}}else cell+=c;}else{if(c==='\"'){q=true;}else if(c===','){cur.push(cell);cell="";}else if(c==='\n'||c==='\r'){if(c==='\r'&&txt[i+1]==='\n')i++;cur.push(cell);out.push(cur);cur=[];cell="";}else cell+=c;}}if(cell!==""||cur.length){cur.push(cell);out.push(cur);}return out;}

let headers=[], rows=[], kept=[], idx={};
let lastRowIdx=-1, lastSymbolShown="";
const interval="D"; 

function autodetect(h){
  const m={};
  h.forEach((hh,i)=>{const nh=norm(hh);
    if(nh.includes("symbol")||nh==="ticker") m.symbol=i;
    if(nh.includes("ann rtn")||nh.includes("annual")) m.ann=i;
    if(nh==="return") m.ret=i;
    if(nh.startsWith("price")) m.price=i; // detect Price column
  });
  if(m.symbol==null) throw new Error("No Symbol column");
  if(m.ann==null && m.ret==null) throw new Error("No Ann Rtn column");
  if(m.price==null) throw new Error("No Price column");
  return m;
}
function dedupeBySymbol(rows, idxSymbol, idxAnn){
  const best=new Map();
  for(let r=1;r<rows.length;r++){
    const row=rows[r]; if(!row?.length) continue;
    const sym=String(row[idxSymbol]||"").trim().toUpperCase(); if(!sym) continue;
    const ann=toNum(row[idxAnn]);
    if(!best.has(sym)) best.set(sym,{row,ann});
    else if(ann>best.get(sym).ann) best.set(sym,{row,ann});
  }
  return Array.from(best.values()).map(x=>x.row);
}
function renderTable(headers, rows, sortCol){
  const wrap=document.getElementById("tablewrap");
  let html="<table id='t'><thead><tr>";
  headers.forEach((h,i)=> html+=`<th data-col='${i}'>${h}${i===sortCol?" ⬇":""}</th>`);
  html+="</tr></thead><tbody>";
  rows.forEach((r,ri)=>{ html+=`<tr data-row='${ri}'><td>${r.map(c=> String(c)).join("</td><td>")}</td></tr>`; });
  html+="</tbody></table>";
  wrap.innerHTML=html;

  // sort
  wrap.querySelectorAll("th").forEach(th=>{
    th.onclick=()=>{
      const c=parseInt(th.dataset.col,10);
      const num=rows.every(rr=>Number.isFinite(toNum(rr[c]))||rr[c]==="");
      rows.sort((a,b)=> num? toNum(b[c])-toNum(a[c]) : String(b[c]).localeCompare(String(a[c])) );
      kept=rows.slice(); lastRowIdx=-1; renderTable(headers, kept, c);
    };
  });

  // hover price cell
  const priceCol=idx.price, symCol=idx.symbol;
  const tbody=document.querySelector("#t tbody");
  if(tbody){
    tbody.addEventListener("mouseover", e=>{
      const cell=e.target.closest("td"); if(!cell) return;
      const tr=cell.parentElement;
      const ri=parseInt(tr.dataset.row,10);
      const ci=[...tr.children].indexOf(cell);
      if(ci!==priceCol) return;
      if(ri===lastRowIdx) return;
      lastRowIdx=ri;
      const rawSym=String(kept[ri][symCol]||"").trim(); if(!rawSym) return;
      anchorToPriceCell(tr, cell, rawSym);
    });
  }
}

function buildChart(symbol){
  const el=document.getElementById("tvContainer");
  el.innerHTML="";
  const innerId="tv_"+Math.random().toString(36).slice(2);
  const inner=document.createElement("div");
  inner.id=innerId; inner.style.width="500px"; inner.style.height="300px";
  el.appendChild(inner);

  new TradingView.widget({
    width:500, height:300, symbol:symbol, interval:interval,
    timezone:"Etc/UTC", theme:"dark", style:"1", locale:"en",
    container_id: innerId, hide_side_toolbar:true, allow_symbol_change:false,
    studies:[{id:"MASimple@tv-basicstudies",inputs:{length:200}}] // add 200MA
  });
}

const panel=document.getElementById("panel");
const panelTitle=document.getElementById("panelTitle");
const panelClose=document.getElementById("panelClose");
const openTVBtn=document.getElementById("openTV");

function anchorToPriceCell(tr, cell, rawSym){
  const prefix=(document.getElementById("prefix").value||"").trim();
  const sym=(prefix?prefix:"")+rawSym.toUpperCase();
  panelTitle.textContent=sym;

  const rect=cell.getBoundingClientRect();
  const panelW=520, panelH=320;
  const viewL=window.scrollX, viewT=window.scrollY;
  const viewW=document.documentElement.clientWidth, viewH=document.documentElement.clientHeight;

  let left=window.scrollX+rect.right+12;
  if(left+panelW>viewL+viewW){ left=window.scrollX+rect.left-panelW-12; if(left<viewL+8) left=viewL+8; }
  let top=window.scrollY+rect.top;
  if(top+panelH>viewT+viewH) top=viewT+viewH-panelH-8;
  if(top<viewT+8) top=viewT+8;

  panel.style.left=left+"px";
  panel.style.top=top+"px";
  panel.style.display="block";

  if(sym!==lastSymbolShown){
    lastSymbolShown=sym;
    buildChart(sym);
  }
  openTVBtn.disabled=false;
  openTVBtn.onclick=()=>window.open("https://www.tradingview.com/chart/?symbol="+encodeURIComponent(sym),"_blank");
}

panelClose.onclick=()=>{ panel.style.display="none"; lastRowIdx=-1; };
window.addEventListener("keydown", e=>{ if(e.key==="Escape"){ panel.style.display="none"; lastRowIdx=-1; }});

document.getElementById("go").onclick=()=>{
  const f=document.getElementById("csv").files[0];
  if(!f){alert("Pick CSV");return;}
  const r=new FileReader();
  r.onload=()=>{
    try{
      const all=parseCSV(String(r.result)); if(all.length<2) throw new Error("CSV empty");
      headers=all[0]; rows=all; idx=autodetect(headers);
      const ann=(idx.ann!=null)?idx.ann:idx.ret;
      kept=dedupeBySymbol(rows, idx.symbol, ann);
      kept.sort((a,b)=> toNum(b[ann]) - toNum(a[ann]) );
      renderTable(headers, kept, ann);
      document.getElementById("stats").textContent=`Input:${rows.length-1} | Kept:${kept.length} | Removed:${rows.length-1-kept.length}`;
      document.getElementById("exportTV").disabled=kept.length===0;
    }catch(e){ alert("Error: "+e.message); }
  };
  r.readAsText(f);
};
</script>
</body>
</html>
